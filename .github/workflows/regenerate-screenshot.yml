name: Regenerate TUI Screenshot

on:
  workflow_dispatch: # Manual trigger only

permissions:
  contents: write
  pull-requests: write

jobs:
  regenerate:
    name: Regenerate Screenshot
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0 # For hatch-vcs

      - name: Set up Python 3.12
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Install dependencies
        run: |
          uv sync

      - name: Regenerate TUI screenshot
        run: |
          # Create script to capture screenshot
          cat > /tmp/capture_screenshot.py << 'EOF'
          from pathlib import Path
          from textual.pilot import Pilot
          from apt_registry_explorer.tui import PackageBrowserApp
          from apt_registry_explorer.packages import PackageMetadata

          # Create sample packages
          packages = [
              PackageMetadata(
                  package="nginx",
                  version="1.18.0-6ubuntu14.4",
                  architecture="amd64",
                  maintainer="Ubuntu Developers",
                  installed_size="1024",
                  depends="libc6 (>= 2.34), libssl3",
                  description="Small, powerful, scalable web/proxy server",
              ),
              PackageMetadata(
                  package="python3",
                  version="3.10.6-1~22.04.1",
                  architecture="amd64",
                  maintainer="Ubuntu Developers",
                  installed_size="512",
                  depends="python3.10 (>= 3.10.6-1~)",
                  description="Interactive high-level object-oriented language",
              ),
              PackageMetadata(
                  package="curl",
                  version="7.81.0-1ubuntu1.18",
                  architecture="amd64",
                  maintainer="Ubuntu Developers",
                  installed_size="384",
                  depends="libc6 (>= 2.34), libcurl4",
                  description="Command line tool for transferring data with URL syntax",
              ),
          ]

          async def capture():
              app = PackageBrowserApp(packages)
              async with app.run_test() as pilot:
                  await pilot.pause(0.5)
                  # Save screenshot
                  screenshot_path = Path("docs/tui-screenshot.svg")
                  screenshot_path.parent.mkdir(exist_ok=True)
                  pilot.app.save_screenshot(screenshot_path)
                  print(f"Screenshot saved to {screenshot_path}")

          import asyncio
          asyncio.run(capture())
          EOF

          uv run python /tmp/capture_screenshot.py

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: regenerate TUI screenshot"
          branch: regenerate-screenshot
          title: "chore: Regenerate TUI Screenshot"
          body: |
            ## Screenshot Regeneration

            This PR updates the TUI screenshot in `docs/tui-screenshot.svg`.

            **Generated by:** @${{ github.actor }}
            **Workflow:** Regenerate TUI Screenshot (manual trigger)

            Please review the updated screenshot and merge if it looks correct.
          labels: documentation, automated
